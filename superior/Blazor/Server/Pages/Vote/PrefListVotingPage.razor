@page "/vote/pref-list"
@using E_Voting.Transfer
@using System.Text.Json
@inject NavigationManager NavManager
@inject IJSRuntime JS

<PageTitle>Vote</PageTitle>

@if (election == null)
{
    return;
}

@if(done)
{
    <div class="listing-div">
        <h3>Thank you!</h3>
        <p>Your vote was tracked.</p>
    </div>
}
else
{
    <div class="logo-header-div">
        <h1>
            Vote
        </h1>
        <img src="logo.png" alt="Superior Voting Logo" />
    </div>
    <div class="listing-div">
        <h3><strong>Election:</strong> @election!.Name</h3>
        <p><strong>Voting System:</strong> @Help.GetSystemName(Help.GetVotingSystem(election.TypeID))</p>
        @if (Token != "public")
        {
            <p><strong>Token:</strong> @Token</p>
        }
        <p>Rank the candidates in order to vote (1 is the highest)</p>

        <table class="table-main">
            <thead>
                <tr>
                    <th>Candidate</th>
                    <th>Ranking</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var candidate in election.Candidates)
                {
                    <tr>
                        <td>@candidate.Name</td>
                        <td>
                            <select class="select-main" @onchange="e => OnScoreSelected(candidate.ID, e.Value?.ToString())">
                                @foreach (var score in availableScores)
                                {
                                    <option value="@score" selected="@(ranking.TryGetValue(candidate.ID, out int val) && val == score)">
                                        @score
                                    </option>
                                }
                            </select>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
        <button class="btn-main" @onclick="Submit">Submit Vote</button>
        @if(message != "")
        {
            <p style="color: red; font-weight: bold;">@message</p>
        }
    </div>
    <br>
    <br />
}


@code {
    [Parameter]
    [SupplyParameterFromQuery]
    public string ElectionID { get; set; } = "";

    [Parameter]
    [SupplyParameterFromQuery]
    public string Token { get; set; } = "";

    private bool done = false;
    private Election? election;
    private Voter? voter;
    private Dictionary<long, int> ranking = new();
    private List<int> availableScores = new();
    private string message = "";

    protected override void OnInitialized()
    {
        if (string.IsNullOrEmpty(Token))
        {
            NavManager.NavigateTo(Routes.InvalidRequest);
            return;
        }
        if (string.IsNullOrEmpty(ElectionID))
        {
            NavManager.NavigateTo(Routes.InvalidRequest);
            return;
        }
        if (!long.TryParse(ElectionID, out long id))
        {
            NavManager.NavigateTo(Routes.InvalidRequest);
            return;
        }

        if(Token == "public")
        {
            election = Database.GetElection(id, false, PrivacyLevel.Voters);
            if (election != null && election.PublicElection && election.Result == Config.EmptyResult && election.End > DateTime.UtcNow)
            {
                VotingSystem system = Help.GetVotingSystem(election.TypeID);
                if (!Help.IsPrefListElection(system))
                {
                    NavManager.NavigateTo(Routes.InvalidRequest);
                }
                LoadElection();
            }
            else
            {
                NavManager.NavigateTo(Routes.InvalidToken);
            }
        }
        else
        {
            voter = Database.CheckToken(Token);
            if (voter != null && voter.ElectionID == id)
            {
                election = Database.GetElection(id, false, PrivacyLevel.Voters);
                if (!voter.Voted)
                {
                    if (election != null && election.Result == Config.EmptyResult && election.End > DateTime.UtcNow)
                    {
                        VotingSystem system = Help.GetVotingSystem(election.TypeID);
                        if (!Help.IsPrefListElection(system))
                        {
                            NavManager.NavigateTo(Routes.InvalidRequest);
                        }
                        LoadElection();
                    }
                    else
                    {
                        NavManager.NavigateTo(Routes.ServerError);
                    }
                }
                else
                {
                    done = true;
                }
            }
            else
            {
                NavManager.NavigateTo(Routes.InvalidToken);
            }
        }
    }

    private void LoadElection()
    {
        int maxScore = Math.Min(election!.Candidates.Count, 10) + 1;
        availableScores = Enumerable.Range(0, maxScore).Reverse().ToList();
        foreach (Candidate candidate in election.Candidates)
        {
            ranking[candidate.ID] = 0;
        }
    }

    private void OnScoreSelected(long id, string? selected)
    {
        if (int.TryParse(selected, out int score))
        {
            ranking[id] = score;
        }
        else
        {
            ranking[id] = 0;
        }
    }

    private void Submit()
    {
        if(election == null)
        {
            NavManager.NavigateTo(Routes.ServerError);
            return;
        }
        if(done)
        {
            return;
        }

        // check election again
        election = Database.GetElection(election.ID, false, PrivacyLevel.Voters);
        if (election == null)
        {
            NavManager.NavigateTo(Routes.InvalidToken);
            return;
        }
        if (election.End < DateTime.UtcNow || election.Result != Config.EmptyResult)
        {
            NavManager.NavigateTo(Routes.InvalidToken);
            return;
        }

        // check token again
        if (Token != "public")
        {
            if (string.IsNullOrEmpty(Token))
            {
                NavManager.NavigateTo(Routes.InvalidToken);
                return;
            }

            voter = Database.CheckToken(Token);
            if (voter == null)
            {
                NavManager.NavigateTo(Routes.InvalidToken);
                return;
            }
            if (voter.Voted)
            {
                NavManager.NavigateTo(Routes.InvalidToken);
                return;
            }
        }

        // clean zeros and check if all rankings are only used once
        Dictionary<long, int> cleaned = ranking.Where(element => element.Value != 0).ToDictionary(element => element.Key, element => element.Value);
        if (cleaned.Count() == 0)
        {
            message = "Please rank the candidates first!";
            return;
        }
        if(cleaned.Values.Count != cleaned.Values.Distinct().Count())
        {
            message = "You can use each rank only once!";
            return;
        }

        List<long> sortedValues = cleaned.OrderBy(pair => pair.Value).Select(pair => pair.Key).ToList();
        if (voter != null)
        {
            done = Database.Vote(election.ID, JsonSerializer.Serialize(sortedValues), voter.ID);
        }
        else
        {
            done = Database.Vote(election.ID, JsonSerializer.Serialize(sortedValues));
        }

        if (!done)
        {
            message = "DB error!";
        }
        else
        {
            message = "";
        }
    }
}
